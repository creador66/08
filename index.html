<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IAEgo Veta</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#F9FAFB; --surface:#FFF;
      --primary:#5A67D8; --primary-hover:#4C51BF;
      --secondary:#2DD4BF; --secondary-hover:#14B8A6;
      --error:#F56565; --success:#48BB78;
      --text:#2D3748; --text-light:#718096;
      --radius:12px; --shadow-sm:rgba(0,0,0,0.05) 0 1px 2px;
      --shadow-md:rgba(0,0,0,0.1) 0 4px 6px;
      --spacing:1rem; --font:'Inter',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--font);padding:var(--spacing);display:flex;justify-content:center;padding-bottom:4rem}
    .container{max-width:1000px;width:100%}
    h1{text-align:center;margin-bottom:var(--spacing);font-weight:600}
    .tabs{display:flex;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);margin-bottom:var(--spacing)}
    .tab{flex:1;text-align:center;padding:.75rem;cursor:pointer;color:var(--text-light);transition:background .2s,color .2s;font-weight:500}
    .tab.active{background:var(--primary);color:#fff}
    #mensaje{position:fixed;top:var(--spacing);right:var(--spacing);max-width:300px;display:none;padding:var(--spacing);border-radius:var(--radius);box-shadow:var(--shadow-md);font-weight:500;z-index:1100}
    fieldset{background:var(--surface);border:none;border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:var(--spacing);margin-bottom:var(--spacing)}
    legend{font-size:1.1rem;color:var(--primary);font-weight:500}
    label{display:block;margin-bottom:.25rem;color:var(--text-light);font-size:.95rem}
    input,select,textarea{width:100%;padding:.65rem;margin-bottom:var(--spacing);border:1px solid #E2E8F0;border-radius:var(--radius);font-size:1rem;font-family:var(--font);color:var(--text)}
    textarea{height:150px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,103,216,0.2)}
    button{font-family:var(--font);font-size:1rem;padding:.65rem 1.4rem;border:none;border-radius:var(--radius);cursor:pointer;transition:background .2s,transform .1s,box-shadow .2s;box-shadow:var(--shadow-sm)}
    button:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
    button:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover)}
    .btn-secondary{background:var(--secondary);color:#fff}
    .btn-secondary:hover{background:var(--secondary-hover)}
    .btn-danger{background:var(--error);color:#fff}
    .action-btn{padding:.4rem .8rem;font-size:.9rem}
    .contenedor-btn{display:flex;gap:3px}
    .table-wrapper{overflow-x:auto;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-sm);margin-bottom:var(--spacing)}
    table{width:100%;border-collapse:collapse;min-width:600px}
    th,td{padding:.75rem;text-align:left;border-bottom:1px solid #E2E8F0;white-space:nowrap;font-size:.95rem}
    th{background:var(--primary);color:#fff;position:sticky;top:0}
    tr:hover td{background:#F1F5F9}
    .flex{display:flex;gap:.5rem;flex-wrap:wrap}
    section{display:none}
    section.active{display:block}
    .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:var(--spacing)}
    .modal{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-md);width:100%;max-width:480px;max-height:80%;display:flex;flex-direction:column;overflow:hidden}
    .modal-header{padding:var(--spacing);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #E2E8F0}
    .modal-header h4{margin:0;font-weight:500;color:var(--text)}
    .modal-header button{font-size:1.4rem;background:transparent;box-shadow:none;color:var(--text-light)}
    .modal-body{padding:var(--spacing);overflow-y:auto;flex:1}
    .modal-footer{padding:var(--spacing);text-align:right;border-top:1px solid #E2E8F0}
    .item-list{list-style:none;padding:0;margin:0}
    .item-list li{display:flex;justify-content:space-between;align-items:center;padding:.65rem;border-bottom:1px solid #E2E8F0;cursor:pointer}
    .item-list li:hover{background:#EDF2F7}
    .item-list li span{flex:1}
    .bottom-menu{position:fixed;bottom:0;left:0;width:100%;background:var(--surface);box-shadow:var(--shadow-sm);display:flex;justify-content:space-between;align-items:center;padding:.75rem var(--spacing);z-index:1050}
    .bottom-menu button{font-size:.95rem;padding:.5rem 1rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>IAEgo Veta</h1>
    <div id="mensaje"></div>
    <div class="tabs">
      <div class="tab active" id="tab-ingredientes">Ingredientes</div>
      <div class="tab" id="tab-recetas">Recetas</div>
    </div>

    <!-- Ingredientes -->
    <section id="sect-ingredientes" class="active">
      <fieldset>
        <legend>‚ûï A√±adir Ingrediente</legend>
        <label for="ing-nombre">Nombre</label>
        <input id="ing-nombre" placeholder="Ej. Az√∫car">
        <label for="ing-cantidad">Cantidad comprada</label>
        <div class="flex">
          <input type="number" id="ing-cantidad" min="0" step="any" placeholder="Ej. 2">
          <select id="ing-unidad"></select>
        </div>
        <label for="ing-precio">Precio total (pesos)</label>
        <input type="number" id="ing-precio" min="0" step="any" placeholder="Ej. 30">
        <button id="btn-add-ingrediente" class="btn-primary">Guardar Ingrediente</button>
      </fieldset>

      <div class="contenedor-btn" style="margin-bottom:1rem">
        <button id="btn-export-ingredientes" class="btn-secondary action-btn">Exportar Ingredientes</button>
        <button id="btn-import-ingredientes" class="btn-secondary action-btn">Importar Ingredientes</button>
      </div>

      <h2>Ingredientes Guardados</h2>
      <div class="table-wrapper">
        <table id="tbl-ingredientes">
          <thead><tr><th>Nombre</th><th>Cantidad</th><th>Precio</th><th>Acci√≥n</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Recetas -->
    <section id="sect-recetas">
      <fieldset>
        <legend>üìù Crear / Editar Receta</legend>
        <label>Ingrediente / Receta</label>
        <button id="btn-open-modal" class="btn-secondary">Seleccionar elemento‚Ä¶</button>
        <select id="rec-ingrediente" style="display:none"></select>
        <label for="rec-cantidad">Cantidad</label>
        <div class="flex">
          <input type="number" id="rec-cantidad" min="0" step="any" placeholder="Ej. 2">
          <select id="rec-unidad"></select>
        </div>
        <div class="contenedor-btn">
          <button id="btn-add-receta-ing" class="btn-secondary">Agregar ingrediente</button>
          <button id="btn-save-receta" class="btn-primary">Guardar Receta</button>
        </div>
      </fieldset>
      <h3>Ingredientes de la receta</h3>
      <div class="table-wrapper">
        <table id="tbl-receta">
          <thead><tr><th>Elemento</th><th>Cantidad</th><th>Costo</th><th>Acci√≥n</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="bottom-menu">
    <button id="btn-view-recipes-bottom" class="btn-secondary">Ver Recetas</button>
    <div>Costo total: $<span id="bottom-costo-total">0.00</span></div>
  </div>

  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h4 id="modal-title"></h4>
        <button id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>

  <script>
    const showMessage=(txt,error=true)=>{
      const m=document.getElementById('mensaje');
      m.textContent=txt;
      m.style.background= error? '#fdecea':'#e9f7ef';
      m.style.color     = error? '#c0392b':'#27ae60';
      m.style.border    = error? '1px solid #e74c3c':'1px solid #2ecc71';
      m.style.display   ='block';
      clearTimeout(m._t);
      m._t=setTimeout(()=>m.style.display='none',4000);
    };

    const tabIng=document.getElementById('tab-ingredientes'),
          tabRec=document.getElementById('tab-recetas'),
          secIng=document.getElementById('sect-ingredientes'),
          secRec=document.getElementById('sect-recetas');
    tabIng.onclick=()=>{ tabIng.classList.add('active'); tabRec.classList.remove('active'); secIng.classList.add('active'); secRec.classList.remove('active'); };
    tabRec.onclick=()=>{ tabRec.classList.add('active'); tabIng.classList.remove('active'); secRec.classList.add('active'); secIng.classList.remove('active'); };

    const unidades={ masa:['mg','g','kg'], volumen:['ml','l'], medida:['tsp','tbsp','cup'], unidad:['u'] };
    const factors={ mg:1/1000,g:1,kg:1000,ml:1,l:1000,tsp:5,tbsp:15,cup:240,u:1 };
    const load=k=>JSON.parse(localStorage.getItem(k)||'[]');
    const save=(k,d)=>localStorage.setItem(k,JSON.stringify(d));

    let ingredientes=load('ingredientes'),
        receta={ nombre:'',porciones:1,items:[] },
        editIngIndex=null, editRecIndex=null, editRecItemIdx=null;

    const ingUniSel   =document.getElementById('ing-unidad'),
          recUniSel   =document.getElementById('rec-unidad'),
          recIngSel   =document.getElementById('rec-ingrediente'),
          tblIngBody  =document.querySelector('#tbl-ingredientes tbody'),
          tblRecBody  =document.querySelector('#tbl-receta tbody'),
          btnAddRecIt =document.getElementById('btn-add-receta-ing'),
          btnOpenModal=document.getElementById('btn-open-modal'),
          btnSaveRec  =document.getElementById('btn-save-receta'),
          btnViewRecs =document.getElementById('btn-view-recipes-bottom'),
          bottomCost  =document.getElementById('bottom-costo-total'),
          modalBkp    =document.getElementById('modal-backdrop'),
          modalTitle  =document.getElementById('modal-title'),
          modalBody   =document.getElementById('modal-body'),
          modalFooter =document.getElementById('modal-footer'),
          btnCloseMod =document.getElementById('modal-close'),
          btnExportIng=document.getElementById('btn-export-ingredientes'),
          btnImportIng=document.getElementById('btn-import-ingredientes');

    function optionsFrom(arr){ return arr.map(o=>`<option value="${o}">${o}</option>`).join(''); }
    function buildOptions(){
      return [
        `<optgroup label="Masa">${optionsFrom(unidades.masa)}</optgroup>`,
        `<optgroup label="Volumen">${optionsFrom(unidades.volumen)}</optgroup>`,
        `<optgroup label="Medidas">${optionsFrom(unidades.medida)}</optgroup>`,
        `<optgroup label="Unidad">${optionsFrom(unidades.unidad)}</optgroup>`
      ].join('');
    }
    ingUniSel.innerHTML=buildOptions();
    recUniSel.innerHTML=buildOptions();

    function buildRecOptions(){
      const recs=load('recetas');
      const ingOpts=ingredientes.map((ing,i)=>`<option value="I${i}">${ing.nombre}</option>`).join('');
      const recOpts=recs.map((r,i)=>`<option value="R${i}">${r.nombre}</option>`).join('');
      return `<optgroup label="Ingredientes">${ingOpts}</optgroup><optgroup label="Recetas">${recOpts}</optgroup>`;
    }

    function updateRecUnidad(){
      const sel=recIngSel.value;
      if(!sel){ recUniSel.innerHTML=buildOptions(); return; }
      const tipo=sel[0], idx=+sel.slice(1);
      if(tipo==='I'){
        const base=ingredientes[idx].unidad;
        let opts,label;
        if(unidades.masa.includes(base)){ opts=unidades.masa; label='Masa'; }
        else if(unidades.volumen.includes(base)){ opts=unidades.volumen.concat(unidades.medida); label='Vol/Med'; }
        else if(unidades.medida.includes(base)){ opts=unidades.medida.concat(unidades.volumen); label='Med/Vol'; }
        else { opts=unidades.unidad; label='Unidad'; }
        recUniSel.innerHTML=`<optgroup label="${label}">${optionsFrom(opts)}</optgroup>`;
      } else {
        recUniSel.innerHTML='<option value="porci√≥n">porci√≥n</option>';
      }
    }

    function getItemCost(it){
      if(it.tipo==='I'){
        const ing=ingredientes[it.idx], pu=ing.precio/(factors[ing.unidad]*ing.cantidad);
        return pu*(factors[it.unidad]*it.cantidad);
      } else {
        const sub=load('recetas')[it.idx], tot=sub.items.reduce((s,x)=>s+getItemCost(x),0);
        return (tot/sub.porciones)*it.cantidad;
      }
    }

    function renderIngredientes(){
      tblIngBody.innerHTML=ingredientes.map((ing,i)=>`
        <tr>
          <td>${ing.nombre}</td>
          <td>${ing.cantidad} ${ing.unidad}</td>
          <td>$${ing.precio.toFixed(2)}</td>
          <td class="contenedor-btn">
            <button class="action-btn btn-primary" onclick="startEditIng(${i})">‚úèÔ∏è</button>
            <button class="action-btn btn-danger" onclick="deleteIng(${i})">üóëÔ∏è</button>
          </td>
        </tr>`).join('');
      recIngSel.innerHTML=buildRecOptions();
      updateRecUnidad();
    }

    function renderReceta(){
      let total=0;
      tblRecBody.innerHTML=receta.items.map((it,i)=>{
        const nombre= it.tipo==='I'
          ? ingredientes[it.idx].nombre
          : load('recetas')[it.idx].nombre+' (porci√≥n)';
        const costo=getItemCost(it);
        total+=costo;
        return `
        <tr>
          <td>${nombre}</td>
          <td>${it.cantidad} ${it.unidad}</td>
          <td>$${costo.toFixed(2)}</td>
          <td class="contenedor-btn">
            <button class="action-btn btn-primary" onclick="startEditRecItem(${i})">‚úèÔ∏è</button>
            <button class="action-btn btn-danger"  onclick="delRecItem(${i})">üóëÔ∏è</button>
          </td>
        </tr>`;}).join('');
      bottomCost.textContent=total.toFixed(2);
    }

    document.getElementById('btn-add-ingrediente').onclick=()=>{
      const n=document.getElementById('ing-nombre'),
            c=document.getElementById('ing-cantidad'),
            p=document.getElementById('ing-precio');
      if(!n.value.trim()) return showMessage('Falta nombre.');
      if(!c.value||c.value<=0) return showMessage('Cantidad > 0.');
      if(!p.value||p.value<=0) return showMessage('Precio > 0.');
      const nuevo={ nombre:n.value.trim(), cantidad:+c.value, unidad:ingUniSel.value, precio:+p.value };
      if(editIngIndex===null){
        ingredientes.push(nuevo); showMessage('Ingrediente guardado.',false);
      } else {
        ingredientes[editIngIndex]=nuevo; showMessage('Ingrediente actualizado.',false);
        editIngIndex=null; document.getElementById('btn-add-ingrediente').textContent='Guardar Ingrediente';
      }
      save('ingredientes',ingredientes);
      [n,c,p].forEach(x=>x.value='');
      renderIngredientes(); renderReceta();
    };

    window.startEditIng=i=>{
      const ing=ingredientes[i];
      document.getElementById('ing-nombre').value=ing.nombre;
      document.getElementById('ing-cantidad').value=ing.cantidad;
      ingUniSel.value=ing.unidad;
      document.getElementById('ing-precio').value=ing.precio;
      editIngIndex=i;
      document.getElementById('btn-add-ingrediente').textContent='Actualizar Ingrediente';
    };

    window.deleteIng=i=>{
      ingredientes.splice(i,1);
      save('ingredientes',ingredientes);
      showMessage('Ingrediente eliminado.',false);
      renderIngredientes(); renderReceta();
    };

    btnAddRecIt.onclick=()=>{
      if(!recIngSel.value) return showMessage('Selecciona un elemento.');
      const tipo=recIngSel.value[0], idx=+recIngSel.value.slice(1), c=+document.getElementById('rec-cantidad').value;
      if(!c||c<=0) return showMessage('Cantidad > 0.');
      const item={ tipo, idx, cantidad:c, unidad:recUniSel.value };
      if(editRecItemIdx===null) receta.items.push(item);
      else {
        receta.items[editRecItemIdx]=item;
        editRecItemIdx=null;
        btnAddRecIt.textContent='Agregar ingrediente';
      }
      renderReceta();
      recIngSel.value=''; recUniSel.innerHTML=buildOptions();
      document.getElementById('rec-cantidad').value='';
      btnOpenModal.textContent='Seleccionar elemento‚Ä¶';
    };

    window.startEditRecItem=i=>{
      const it=receta.items[i];
      editRecItemIdx=i;
      recIngSel.value=it.tipo+it.idx; updateRecUnidad();
      document.getElementById('rec-cantidad').value=it.cantidad;
      btnOpenModal.textContent= it.tipo==='I'
        ? ingredientes[it.idx].nombre
        : load('recetas')[it.idx].nombre+' (receta)';
      btnAddRecIt.textContent='Actualizar ingrediente';
    };

    window.delRecItem=i=>{ receta.items.splice(i,1); renderReceta(); };

    window.startEditRec=i=>{
      tabRec.click();
      const r=load('recetas')[i];
      receta=JSON.parse(JSON.stringify(r));
      editRecIndex=i; editRecItemIdx=null;
      btnOpenModal.textContent='Seleccionar elemento‚Ä¶';
      btnAddRecIt.textContent='Agregar ingrediente';
      renderReceta(); updateRecUnidad();
    };

    function openModal(){ modalBkp.style.display='flex'; }
    function closeModal(){ modalBkp.style.display='none'; modalBody.innerHTML=''; modalFooter.innerHTML=''; }
    btnCloseMod.onclick=closeModal;

    function showSelectModal(items,onSelect,isRecList=false){
      modalTitle.textContent=isRecList?'Recetas Guardadas':'Seleccionar Ingrediente/Receta';
      modalBody.innerHTML='<ul class="item-list">'+items.map((it,i)=>`
        <li data-value="${it.value||''}" data-index="${it.index!=null?it.index:i}">
          <span>${it.label}</span>
          ${isRecList?`<button class="action-btn btn-primary" data-action="edit">‚úèÔ∏è</button>
            <button class="action-btn btn-danger" data-action="delete">üóëÔ∏è</button>`:''}
        </li>`).join('')+'</ul>';
      modalFooter.innerHTML='';
      modalBody.querySelectorAll('li').forEach(li=>{
        const idx=+li.dataset.index;
        if(isRecList){
          li.querySelectorAll('button').forEach(btn=>{
            btn.onclick=e=>{
              e.stopPropagation();
              if(btn.dataset.action==='edit'){ startEditRec(idx); closeModal(); }
              else{ deleteRec(idx); li.remove(); }
            };
          });
        } else {
          li.onclick=()=>{
            onSelect({ value:li.dataset.value, label:li.querySelector('span').textContent });
            closeModal();
          };
        }
      });
      openModal();
    }

    btnOpenModal.onclick=()=>{
      const recs=load('recetas');
      const items=[
        ...ingredientes.map((ing,i)=>({ label:ing.nombre, value:`I${i}` })),
        ...recs.map((r,i)=>({ label:r.nombre, value:`R${i}` }))
      ];
      showSelectModal(items,sel=>{
        recIngSel.value=sel.value; updateRecUnidad();
        btnOpenModal.textContent=sel.label;
      },false);
    };

    function showSaveRecipeModal(){
      modalTitle.textContent=editRecIndex===null?'Guardar Receta':'Actualizar Receta';
      modalBody.innerHTML=`
        <label>Nombre de la receta</label>
        <input id="modal-rec-nombre" placeholder="Ej. Limonada">
        <label>Porciones que rinde</label>
        <input type="number" id="modal-rec-porciones" min="1" step="1" placeholder="Ej. 4">`;
      modalFooter.innerHTML=`
        <button id="modal-cancel" class="btn-secondary">Cancelar</button>
        <button id="modal-confirm" class="btn-primary">Confirmar</button>`;
      const inN=document.getElementById('modal-rec-nombre'),
            inP=document.getElementById('modal-rec-porciones');
      if(editRecIndex!==null){ inN.value=receta.nombre; inP.value=receta.porciones; }
      document.getElementById('modal-cancel').onclick=closeModal;
      document.getElementById('modal-confirm').onclick=()=>{
        const nombre=inN.value.trim(), porciones=parseInt(inP.value,10);
        if(!nombre) return showMessage('La receta necesita nombre.');
        if(isNaN(porciones)||porciones<1) return showMessage('Porciones debe ser ‚â• 1.');
        receta.nombre=nombre; receta.porciones=porciones;
        const todas=load('recetas');
        if(editRecIndex===null){ todas.push(receta); showMessage('Receta guardada.',false); }
        else{ todas[editRecIndex]=receta; showMessage('Receta actualizada.',false); }
        save('recetas',todas);
        receta={ nombre:'',porciones:1,items:[] };
        editRecIndex=null; editRecItemIdx=null;
        btnAddRecIt.textContent='Agregar ingrediente';
        btnOpenModal.textContent='Seleccionar elemento‚Ä¶';
        renderReceta(); closeModal();
      };
      openModal();
    }
    btnSaveRec.onclick=showSaveRecipeModal;

    btnViewRecs.onclick=()=>{
      const todas=load('recetas');
      const recs=todas.map((r,i)=>{
        const costoTotal=r.items.reduce((s,it)=>s+getItemCost(it),0).toFixed(2);
        return{ label:`${r.nombre} ‚Äî ${r.items.length} √≠tems ‚Äî Costo: $${costoTotal}`, index:i };
      });
      showSelectModal(recs,null,true);
    };

    window.deleteRec=i=>{
      const arr=load('recetas'); arr.splice(i,1); save('recetas',arr);
      showMessage('Receta eliminada.',false);
    };

    btnExportIng.onclick=()=>{
      try{
        const json=JSON.stringify(ingredientes,null,2);
        navigator.clipboard.writeText(json).then(
          ()=>showMessage('Ingredientes copiados al portapapeles.',false),
          ()=>showMessage('No se pudo copiar al portapapeles.')
        );
      }catch{ showMessage('Error al generar JSON.'); }
    };

    btnImportIng.onclick=()=>{
      modalTitle.textContent='Importar Ingredientes';
      modalBody.innerHTML=`<p>Pega aqu√≠ el JSON exportado:</p><textarea id="import-json"></textarea>`;
      modalFooter.innerHTML=`
        <button id="import-cancel" class="btn-secondary">Cancelar</button>
        <button id="import-confirm" class="btn-primary">Pegar</button>`;
      document.getElementById('import-cancel').onclick=closeModal;
      document.getElementById('import-confirm').onclick=()=>{
        const text=document.getElementById('import-json').value.trim();
        try{
          const arr=JSON.parse(text);
          if(!Array.isArray(arr)) throw '';
          for(const ing of arr){
            if(typeof ing.nombre!=='string'||typeof ing.cantidad!=='number'
            ||typeof ing.unidad!=='string'||typeof ing.precio!=='number') throw '';
          }
          ingredientes=arr; save('ingredientes',ingredientes);
          renderIngredientes(); renderReceta();
          showMessage('Ingredientes importados correctamente.',false);
          closeModal();
        }catch{ showMessage('JSON inv√°lido o formato incorrecto.'); }
      };
      openModal();
    };

    renderIngredientes();
    renderReceta();
    recIngSel.addEventListener('change', updateRecUnidad);
  </script>
</body>
</html>
