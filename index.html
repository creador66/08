 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IAEgo Costeo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#F9FAFB; --surface:#FFF;
      --primary:#5A67D8; --primary-hover:#4C51BF;
      --secondary:#2D99A8; --secondary-hover:#14B8A6;
      --error:#F56565; --success:#48BB78;
      --text:#2D3748; --text-light:#718096;
      --radius:12px; --shadow-sm:rgba(0,0,0,0.05) 0 1px 2px;
      --shadow-md:rgba(0,0,0,0.1) 0 4px 6px;
      --spacing:1rem; --font:'Inter',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--font);padding:var(--spacing);display:flex;justify-content:center;padding-bottom:4rem}
    .container{max-width:1000px;width:100%}
    h1{text-align:center;margin-bottom:var(--spacing);font-weight:600}
    .tabs{display:flex;background:var(--surface);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);margin-bottom:var(--spacing)}
    .tab{flex:1;text-align:center;padding:.75rem;cursor:pointer;color:var(--text-light);transition:background .2s,color .2s;font-weight:500}
    .tab.active{background:var(--primary);color:#fff}
    #mensaje{position:fixed;top:var(--spacing);right:var(--spacing);max-width:300px;display:none;padding:var(--spacing);border-radius:var(--radius);box-shadow:var(--shadow-md);font-weight:500;z-index:1100}
    fieldset{background:var(--surface);border:none;border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:var(--spacing);margin-bottom:var(--spacing)}
    legend{font-size:1.1rem;color:var(--primary);font-weight:500}
    label{display:block;margin-bottom:.25rem;color:var(--text-light);font-size:.95rem}
    input,select,textarea{width:100%;padding:.65rem;margin-bottom:var(--spacing);border:1px solid #E2E8F0;border-radius:var(--radius);font-size:1rem;font-family:var(--font);color:var(--text)}
    textarea{height:150px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(90,103,216,0.2)}
    button{font-family:var(--font);font-size:1rem;padding:.65rem 1.4rem;border:none;border-radius:var(--radius);cursor:pointer;transition:background .2s,transform .1s,box-shadow .2s;box-shadow:var(--shadow-sm)}
    button:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
    button:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--primary-hover)}
    .btn-secondary{background:var(--secondary);color:#fff}
    .btn-secondary:hover{background:var(--secondary-hover)}
    .btn-danger{background:var(--error);color:#fff}
    .action-btn{padding:.4rem .8rem;font-size:.9rem}
   .contenedor-btn {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 3px;
}




.cards-container {
  display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 5px;
  
  margin-top: var(--spacing);
}
.card {
  background: var(--surface);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  padding: var(--spacing);
  display: flex;
  flex-direction: column;
  transition: transform .2s, box-shadow .2s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-md);
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 500;
  margin-bottom: .5rem;
}
.card-body {
  flex: 1;
  color: var(--text-light);
  font-size: .9rem;
}
.card-footer {
  display: flex;
  gap: .5rem;
  justify-content: flex-end;
  margin-top: .5rem;
}
.card-item {
  display: flex;
  justify-content: space-between;
  padding: .4rem 0;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.card-item:last-child {
  border-bottom: none;
}
.card-item-label {
  font-weight: 500;
}
.card-item-value {
  text-align: right;
}
.cost-badge {
  background: var(--primary);
  color: #fff;
  padding: .2rem .5rem;
  border-radius: 10px;
  font-size: .85rem;
  font-weight: 500;
}







    .flex{display:flex;gap:.5rem;flex-wrap:wrap}
    section{display:none}
    section.active{display:block}
    .modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:var(--spacing)}
    .modal{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow-md);width:100%;max-width:480px;max-height:80%;display:flex;flex-direction:column;overflow:hidden}
    .modal-header{padding:var(--spacing);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #E2E8F0}
    .modal-header h4{margin:0;font-weight:500;color:var(--text)}
    .modal-header button{font-size:1.4rem;background:transparent;box-shadow:none;color:var(--text-light)}
    .modal-body{padding:var(--spacing);overflow-y:auto;flex:1}
    .modal-footer{padding:var(--spacing);text-align:right;border-top:1px solid #E2E8F0}
    .item-list{list-style:none;padding:0;margin:0}
    .item-list li{display:flex;justify-content:space-between;align-items:center;padding:.65rem;border-bottom:1px solid #E2E8F0;cursor:pointer}
    .item-list li:hover{background:#EDF2F7}
    .item-list li span{flex:1}
    .bottom-menu{position:fixed;bottom:0;left:0;width:100%;background:var(--surface);box-shadow:var(--shadow-sm);display:flex;justify-content:space-between;align-items:center;padding:.75rem var(--spacing);z-index:1050}
    .bottom-menu button{font-size:.95rem;padding:.5rem 1rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>IAEgo Costeo</h1>
    <div id="mensaje"></div>
    <div class="tabs">
      <div class="tab active" id="tab-ingredientes">+ Ingredientes</div>
      <div class="tab" id="tab-recetas">+ Recetas</div>
    </div>

    <!-- Ingredientes -->
    <section id="sect-ingredientes" class="active">
      <fieldset>
        <legend>‚ûï A√±adir Ingrediente</legend>
        <label for="ing-nombre">Nombre</label>
        <input id="ing-nombre" placeholder="Ej. Az√∫car">
        <label for="ing-cantidad">Cantidad comprada</label>
        <div class="flex">
          <input type="number" id="ing-cantidad" min="0" step="any" placeholder="Ej. 2">
          <select id="ing-unidad"></select>
        </div>
        <label for="ing-precio">Precio total (pesos)</label>
        <input type="number" id="ing-precio" min="0" step="any" placeholder="Ej. 30">
        <button id="btn-add-ingrediente" class="btn-primary">Guardar Ingrediente</button>
      </fieldset>
      <div class="contenedor-btn" style="margin-bottom:1rem">
        <button id="btn-export-ingredientes" class="btn-secondary action-btn">Exportar Ingredientes</button>
        <button id="btn-import-ingredientes" class="btn-secondary action-btn">Importar Ingredientes</button>
        <!-- NUEVOS BOTONES -->

<button id="btn-clear-all" class="btn-danger action-btn">üóëÔ∏è Borrar todo</button>

        <button id="btn-copy-ingredientes-list" class="btn-secondary action-btn">Copiar Lista Ingredientes</button>
        <button id="btn-copy-recetas-info" class="btn-secondary action-btn">Copiar Recetas Detalladas</button>
      </div>

      
     <h2>Ingredientes Guardados</h2>
<div id="cards-ingredientes" class="cards-container"></div>

    </section>

    <!-- Recetas -->
    <section id="sect-recetas">
      <fieldset>
        <legend>üìù Crear / Editar Receta</legend>
        <label>Ingrediente / Receta</label>
        <button id="btn-open-modal" class="btn-secondary">Seleccionar elemento‚Ä¶</button>
        <select id="rec-ingrediente" style="display:none"></select>
        <label for="rec-cantidad">Cantidad</label>
        <div class="flex">
          <input type="number" id="rec-cantidad" min="0" step="any" placeholder="Ej. 2">
          <select id="rec-unidad"></select>
        </div>
        <div class="contenedor-btn">
          <button id="btn-add-receta-ing" class="btn-secondary">Agregar ingrediente</button>
          <button id="btn-save-receta" class="btn-primary">Guardar Receta</button>
        </div>
      </fieldset>
     <h3>Ingredientes de la receta</h3>
<div id="cards-receta-items" class="cards-container"></div>

    </section>
  </div>

  <div class="bottom-menu">
    <button id="btn-view-recipes-bottom" class="btn-secondary">Ver Recetas</button>
    <div>Costo total: $<span id="bottom-costo-total">0.00</span></div>
  </div>

  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h4 id="modal-title"></h4>
        <button id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>

  <script>
    // Helpers de UI y storage
    const showMessage = (txt, error = true) => {
      const m = document.getElementById('mensaje');
      m.textContent = txt;
      m.style.background = error ? '#fdecea' : '#e9f7ef';
      m.style.color      = error ? '#c0392b' : '#27ae60';
      m.style.border     = error ? '1px solid #e74c3c' : '1px solid #2ecc71';
      m.style.display    = 'block';
      clearTimeout(m._t);
      m._t = setTimeout(() => m.style.display = 'none', 4000);
    };
    const load = k => JSON.parse(localStorage.getItem(k) || '[]');
    const save = (k, d) => localStorage.setItem(k, JSON.stringify(d));
    // Buscar √≠ndice por id
    const findIndexById = (arr, id) => arr.findIndex(x => x.id === +id);

    // Estado global
    let ingredientes = load('ingredientes'),
        recetas      = load('recetas'),
        receta       = { id:null, nombre:'', porciones:1, items:[] },
        editIngId    = null,
        editRecId    = null,
        editRecItemIdx = null;

    // Modal gen√©rico
    const modalBkp    = document.getElementById('modal-backdrop'),
          modalTitle  = document.getElementById('modal-title'),
          modalBody   = document.getElementById('modal-body'),
          modalFooter = document.getElementById('modal-footer'),
          btnCloseMod = document.getElementById('modal-close');
    function openModal(){ modalBkp.style.display = 'flex'; }
    function closeModal(){ modalBkp.style.display = 'none'; modalBody.innerHTML=''; modalFooter.innerHTML=''; }
    btnCloseMod.onclick = closeModal;

    // Mostrar modal de uso antes de eliminar
    function showUsageModal(type, id, usedRecIndices) {
  modalTitle.textContent = `No se puede eliminar ${type}`;
  
  // Contenedor de tarjetas
  modalBody.innerHTML = `
    <p>Est√° en uso en las siguientes recetas. El√≠minalas primero:</p>
    <div id="usage-cards" class="cards-container">
      ${usedRecIndices.map(idx => {
        const rec = recetas[idx];
        return `
          <div class="card" data-rec-index="${idx}">
            <div class="card-header">
              <span>${rec.nombre}</span>
            </div>
            <div class="card-body">
              <div class="card-item">
                <span class="card-item-label">Porciones:</span>
                <span class="card-item-value">${rec.porciones}</span>
              </div>
            </div>
            <div class="card-footer">
              <button class="action-btn btn-danger btn-del-rec" data-index="${idx}">
                üóëÔ∏è Eliminar receta
              </button>
            </div>
          </div>`;
      }).join('')}
    </div>`;
  
  modalFooter.innerHTML = '';

  // Handler para cada bot√≥n de borrar receta
  modalBody.querySelectorAll('.btn-del-rec').forEach(btn => {
    btn.onclick = e => {
      e.stopPropagation();
      const recIdx = +btn.dataset.index;
      // Elimina la receta referenciada
      deleteRecConfirmed(recetas[recIdx].id);
      // Quita la tarjeta
      const card = btn.closest('.card');
      card.remove();
      // Si ya no quedan tarjetas, mostramos confirmaci√≥n final
      const remaining = modalBody.querySelectorAll('.card').length;
      if (remaining === 0) {
        modalBody.innerHTML = `
          <p>Ya no hay recetas que usen este ${type}. ¬øConfirmas eliminar?</p>`;
        modalFooter.innerHTML = `
          <button id="confirm-delete-original" class="btn-primary">
            Eliminar ${type}
          </button>`;
        document.getElementById('confirm-delete-original').onclick = () => {
          if (type === 'ingrediente') deleteIngConfirmed(id);
          else deleteRecConfirmed(id);
          closeModal();
        };
      }
    };
  });

  openModal();
}

    // Eliminar ingrediente
    window.deleteIng = id => {
      const idx = findIndexById(ingredientes, id);
      if (idx === -1) return;
      const usadas = recetas
        .map((r,ri) => r.items.some(it => it.tipo==='I'&&it.id===+id)?ri:-1)
        .filter(ri => ri!==-1);
      if (usadas.length) return showUsageModal('ingrediente', id, usadas);
      deleteIngConfirmed(id);
    };
    function deleteIngConfirmed(id) {
      const idx = findIndexById(ingredientes, id);
      ingredientes.splice(idx,1);
      recetas = recetas.map(r=>{
        r.items = r.items.filter(it=>!(it.tipo==='I'&&it.id===+id));
        return r;
      });
      save('ingredientes',ingredientes);
      save('recetas',recetas);
      showMessage('Ingrediente eliminado.', false);
      renderIngredientes();
      renderReceta();
    }

    // Eliminar receta
    window.deleteRec = id => {
      const idx = findIndexById(recetas, id);
      if (idx === -1) return;
      const usadas = recetas
        .map((r,ri) => r.items.some(it => it.tipo==='R'&&it.id===+id)?ri:-1)
        .filter(ri => ri!==-1);
      if (usadas.length) return showUsageModal('receta', id, usadas);
      deleteRecConfirmed(id);
    };
    function deleteRecConfirmed(id) {
      let idx = findIndexById(recetas, id);
      recetas.splice(idx,1);
      recetas = recetas.map(r=>{
        r.items = r.items.filter(it=>!(it.tipo==='R'&&it.id===+id));
        return r;
      });
      save('recetas',recetas);
      showMessage('Receta eliminada.', false);
      renderReceta();
      renderIngredientes();
    }

    // Unidades y factors
    const unidades = { masa:['mg','g','kg'], volumen:['ml','l'], medida:['tsp','tbsp','cup'], unidad:['u'] };
    const factors  = { mg:1/1000,g:1,kg:1000,ml:1,l:1000,tsp:5,tbsp:15,cup:240,u:1 };

    // Construcci√≥n de selects
    function optionsFrom(arr){ return arr.map(o=>`<option value="${o}">${o}</option>`).join(''); }
    function buildOptions(){
      return [
        `<optgroup label="Masa">${optionsFrom(unidades.masa)}</optgroup>`,
        `<optgroup label="Volumen">${optionsFrom(unidades.volumen)}</optgroup>`,
        `<optgroup label="Medidas">${optionsFrom(unidades.medida)}</optgroup>`,
        `<optgroup label="Unidad">${optionsFrom(unidades.unidad)}</optgroup>`
      ].join('');
    }
    function buildRecOptions(){
      const ingOpts = ingredientes.map(ing=>`<option value="I${ing.id}">${ing.nombre}</option>`).join('');
      const recOpts = recetas.map(r=> editRecId===r.id?'':`<option value="R${r.id}">${r.nombre}</option>` ).join('');
      return `<optgroup label="Ingredientes">${ingOpts}</optgroup><optgroup label="Recetas">${recOpts}</optgroup>`;
    }

    // C√°lculo de costo (protege ciclos)
    function getItemCost(it, visited=[]){
      if (it.tipo==='I'){
        const ing = ingredientes.find(x=>x.id===it.id);
        const pu = ing.precio / (factors[ing.unidad]*ing.cantidad);
        return pu * (factors[it.unidad]*it.cantidad);
      } else {
        if (visited.includes(it.id)) return 0;
        const sub = recetas.find(r=>r.id===it.id), nextV = visited.concat(it.id);
        const tot = sub.items.reduce((s,x)=>s+getItemCost(x,nextV),0);
        return (tot/sub.porciones)*it.cantidad;
      }
    }

    // DOM selectors
    const ingUniSel    = document.getElementById('ing-unidad'),
          recUniSel    = document.getElementById('rec-unidad'),
          recIngSel    = document.getElementById('rec-ingrediente'),
          tblIngBody   = document.querySelector('#tbl-ingredientes tbody'),
          tblRecBody   = document.querySelector('#tbl-receta tbody'),
          btnAddRecIt  = document.getElementById('btn-add-receta-ing'),
          btnOpenModal = document.getElementById('btn-open-modal'),
          btnSaveRec   = document.getElementById('btn-save-receta'),
          btnViewRecs  = document.getElementById('btn-view-recipes-bottom'),
          bottomCost   = document.getElementById('bottom-costo-total'),
          btnExportIng = document.getElementById('btn-export-ingredientes'),
          btnImportIng = document.getElementById('btn-import-ingredientes'),
          tabIng       = document.getElementById('tab-ingredientes'),
          tabRec       = document.getElementById('tab-recetas'),
          secIng       = document.getElementById('sect-ingredientes'),
          secRec       = document.getElementById('sect-recetas');

    // Init selects
    ingUniSel.innerHTML = buildOptions();
    recUniSel.innerHTML = buildOptions();

    // Tabs
    tabIng.onclick = () => {
      tabIng.classList.add('active'); tabRec.classList.remove('active');
      secIng.classList.add('active'); secRec.classList.remove('active');
    };
    tabRec.onclick = () => {
  // S√≥lo limpio el formulario si NO hay una receta en edici√≥n
  if (editRecId === null) {
    receta = { id:null, nombre:'', porciones:1, items:[] };
    btnOpenModal.textContent = 'Seleccionar elemento‚Ä¶';
    btnAddRecIt.textContent = 'Agregar ingrediente';
    renderReceta();
  }
  tabRec.classList.add('active');
  tabIng.classList.remove('active');
  secRec.classList.add('active');
  secIng.classList.remove('active');
};

    // Render ingredientes
 function renderIngredientes() {
  ingredientes = load('ingredientes');
  const container = document.getElementById('cards-ingredientes');
  container.innerHTML = ingredientes.map(ing => {
    // costo unitario
    const pu = ing.precio / (factors[ing.unidad] * ing.cantidad);
    return `
      <div class="card">
        <div class="card-header">
          <span>${ing.nombre}</span>
          <span class="cost-badge">$${pu.toFixed(2)}/${ing.unidad}</span>
        </div>
        <div class="card-body">
          <div class="card-item">
            <span class="card-item-label">Cantidad:</span>
            <span class="card-item-value">${ing.cantidad} ${ing.unidad}</span>
          </div>
          <div class="card-item">
            <span class="card-item-label">Precio total:</span>
            <span class="card-item-value">$${ing.precio.toFixed(2)}</span>
          </div>
        </div>
        <div class="card-footer">
          <button class="action-btn btn-primary" onclick="startEditIng('${ing.id}')">‚úèÔ∏è</button>
          <button class="action-btn btn-danger"  onclick="deleteIng('${ing.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');
  
  // Y actualizas tambi√©n el select de ingredientes en recetas
  recIngSel.innerHTML = buildRecOptions();
  updateRecUnidad();
}

    // Render receta
    function renderReceta() {
  // recarga el objeto receta con items actualizados
  receta = receta; // ya la tienes en estado global
  const container = document.getElementById('cards-receta-items');
  let total = 0;

  container.innerHTML = receta.items.map((it, i) => {
    // Determinar nombre y costo
    let nombre, costo;
    if (it.tipo === 'I') {
      const ing = ingredientes.find(x => x.id === it.id);
      nombre = ing.nombre;
      costo = getItemCost(it);
    } else {
      const sub = recetas.find(r => r.id === it.id);
      nombre = `${sub.nombre} (subreceta)`;
      costo = getItemCost(it);
    }
    total += costo;

    return `
      <div class="card" data-idx="${i}">
        <div class="card-header">
          <span>${nombre}</span>
          <span class="cost-badge">$${costo.toFixed(2)}</span>
        </div>
        <div class="card-body">
          <div class="card-item">
            <span class="card-item-label">Cantidad:</span>
            <span class="card-item-value">${it.cantidad} ${it.unidad}</span>
          </div>
        </div>
        <div class="card-footer">
          <button class="action-btn btn-primary" onclick="startEditRecItem(${i})">‚úèÔ∏è</button>
          <button class="action-btn btn-danger"  onclick="delRecItem(${i})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');

  // Actualiza el costo total en el footer inferior
  bottomCost.textContent = total.toFixed(2);
}

    // A√±adir/editar ingrediente
    document.getElementById('btn-add-ingrediente').onclick = ()=>{
      const n = document.getElementById('ing-nombre'),
            c = document.getElementById('ing-cantidad'),
            p = document.getElementById('ing-precio');
      if(!n.value.trim()) return showMessage('Falta nombre.');
      if(!c.value||c.value<=0) return showMessage('Cantidad > 0.');
      if(!p.value||p.value<=0) return showMessage('Precio > 0.');
      const nuevo = {
        id: editIngId || Date.now(),
        nombre: n.value.trim(),
        cantidad: +c.value,
        unidad: ingUniSel.value,
        precio: +p.value
      };
      ingredientes = load('ingredientes');
      if (editIngId===null){
        ingredientes.push(nuevo);
        showMessage('Ingrediente guardado.', false);
      } else {
        const idx = findIndexById(ingredientes, editIngId);
        ingredientes[idx] = nuevo;
        showMessage('Ingrediente actualizado.', false);
        editIngId = null;
        document.getElementById('btn-add-ingrediente').textContent='Guardar Ingrediente';
      }
      save('ingredientes',ingredientes);
      [n,c,p].forEach(x=>x.value='');
      renderIngredientes();
      renderReceta();
    };
    window.startEditIng = id=>{
      const ing = load('ingredientes').find(x=>x.id===+id);
      document.getElementById('ing-nombre').value = ing.nombre;
      document.getElementById('ing-cantidad').value = ing.cantidad;
      ingUniSel.value = ing.unidad;
      document.getElementById('ing-precio').value = ing.precio;
      editIngId = +id;
      document.getElementById('btn-add-ingrediente').textContent='Actualizar Ingrediente';
    };

    // A√±adir/editar √≠tem de receta
    btnAddRecIt.onclick = ()=>{
      if(!recIngSel.value) return showMessage('Selecciona un elemento.');
      const tipo = recIngSel.value[0],
            id   = +recIngSel.value.slice(1),
            c    = +document.getElementById('rec-cantidad').value;
      if(!c||c<=0) return showMessage('Cantidad > 0.');
      const item = { tipo, id, cantidad:c, unidad:recUniSel.value };
      if(editRecItemIdx===null) receta.items.push(item);
      else {
        receta.items[editRecItemIdx] = item;
        editRecItemIdx = null;
        btnAddRecIt.textContent = 'Agregar ingrediente';
      }
      renderReceta();
      recIngSel.value = '';
      recUniSel.innerHTML = buildOptions();
      document.getElementById('rec-cantidad').value = '';
      btnOpenModal.textContent = 'Seleccionar elemento‚Ä¶';
    };
    window.startEditRecItem = i=>{
      const it = receta.items[i];
      editRecItemIdx = i;
      recIngSel.value = it.tipo + it.id;
      updateRecUnidad();
      document.getElementById('rec-cantidad').value = it.cantidad;
      btnOpenModal.textContent = it.tipo==='I'
        ? ingredientes.find(x=>x.id===it.id).nombre
        : (recetas.find(r=>r.id===it.id).nombre + ' (receta)');
      btnAddRecIt.textContent = 'Actualizar ingrediente';
    };
    window.delRecItem = i=>{ receta.items.splice(i,1); renderReceta(); };

    // Editar receta completa
    window.startEditRec = id=>{
      editRecId = +id;
      receta = JSON.parse(JSON.stringify(recetas.find(r=>r.id===+id)));
      receta.id = +id;
      tabRec.click();
      btnOpenModal.textContent = 'Seleccionar elemento‚Ä¶';
      btnAddRecIt.textContent = 'Agregar ingrediente';
      renderReceta();
      updateRecUnidad();
    };

function showSelectModal(items, onSelect, isRecList = false) {
  modalTitle.textContent = isRecList
    ? 'Recetas Guardadas'
    : 'Seleccionar Ingrediente/Receta';

  // Construimos la vista en tarjetas
  modalBody.innerHTML = `<div class="cards-container">` +
    items.map((it, idx) => {
      const isRec = isRecList;
      let headerLabel = it.label;
      let badge = '';
      let bodyHtml = '';

      if (!isRec) {
        if (it.value.startsWith('I')) {
          const id = +it.value.slice(1);
          const ing = ingredientes.find(x => x.id === id);
          const pu = ing.precio / (factors[ing.unidad] * ing.cantidad);
          badge = `<span class="cost-badge">$${pu.toFixed(2)}/${ing.unidad}</span>`;
          bodyHtml = `
            <div class="card-item">
              <span class="card-item-label">Cantidad:</span>
              <span class="card-item-value">${ing.cantidad} ${ing.unidad}</span>
            </div>
            <div class="card-item">
              <span class="card-item-label">Precio:</span>
              <span class="card-item-value">$${ing.precio.toFixed(2)}</span>
            </div>`;
        } else {
          // it.value es 'R{id}', mostramos nombre + porciones
          const id = +it.value.slice(1);
          const rec = recetas.find(r => r.id === id);
          badge = `<span class="cost-badge">Rinde ${rec.porciones}</span>`;
          bodyHtml = `
            <div class="card-item">
              <span class="card-item-label">Porciones:</span>
              <span class="card-item-value">${rec.porciones}</span>
            </div>`;
        }
      } else {
        // Recetas guardadas: it.index apunta a posici√≥n en recetas[]
        const rec = recetas[it.index];
        const costoTotal = rec.items.reduce((s, x) => s + getItemCost(x), 0);
        const costoPorcion = costoTotal / rec.porciones;
        badge = `<span class="cost-badge">$${costoPorcion.toFixed(2)}/porci√≥n</span>`;
        // Opcional: show n√∫mero de √≠tems
        bodyHtml = `
          <div class="card-item">
            <span class="card-item-label">Items:</span>
            <span class="card-item-value">${rec.items.length}</span>
          </div>
          <div class="card-item">
            <span class="card-item-label">Costo total:</span>
            <span class="card-item-value">$${costoTotal.toFixed(2)}</span>
          </div>`;
      }

      return `
        <div class="card" data-value="${it.value||''}" data-index="${it.index!=null?it.index:idx}">
          <div class="card-header">
            <span>${headerLabel}</span>
            ${badge}
          </div>
          <div class="card-body">
            ${bodyHtml}
          </div>
          <div class="card-footer">
            ${isRecList
              ? `<button class="action-btn btn-primary" data-action="edit">‚úèÔ∏è</button>
                 <button class="action-btn btn-danger"  data-action="delete">üóëÔ∏è</button>`
              : ``
            }
          </div>
        </div>`;
    }).join('') +
  `</div>`;
  modalFooter.innerHTML = '';

  // Enlazamos eventos
  modalBody.querySelectorAll('.card').forEach(card => {
    const value = card.dataset.value;
    const index = +card.dataset.index;

    if (!isRecList) {
      // Selecci√≥n de ingrediente/receta para armar
      card.onclick = () => {
        onSelect({ value, label: card.querySelector('.card-header span').textContent });
        closeModal();
      };
    } else {
      // Recetas guardadas: editar o borrar
      card.querySelector('[data-action="edit"]').onclick = e => {
        e.stopPropagation();
        startEditRec(recetas[index].id);
        closeModal();
      };
      card.querySelector('[data-action="delete"]').onclick = e => {
        e.stopPropagation();
        deleteRec(recetas[index].id);
        card.remove();
      };
    }
  });

  openModal();
}

    btnOpenModal.onclick = ()=>{
      const items = [
        ...ingredientes.map(ing=>({ label: ing.nombre, value: `I${ing.id}` })),
        ...recetas.map(r   =>({ label: r.nombre, value: `R${r.id}` }))
      ];
      showSelectModal(items, sel=>{
        recIngSel.value = sel.value;
        updateRecUnidad();
        btnOpenModal.textContent = sel.label;
      }, false);
    };

    // Guardar receta
    function showSaveRecipeModal(){
      modalTitle.textContent = editRecId===null ? 'Guardar Receta' : 'Actualizar Receta';
      modalBody.innerHTML = `
        <label>Nombre de la receta</label>
        <input id="modal-rec-nombre" placeholder="Ej. Limonada">
        <label>Porciones que rinde</label>
        <input type="number" id="modal-rec-porciones" min="1" step="1" placeholder="Ej. 4">`;
      modalFooter.innerHTML = `
        <button id="modal-cancel" class="btn-secondary">Cancelar</button>
        <button id="modal-confirm" class="btn-primary">Confirmar</button>`;
      const inN = document.getElementById('modal-rec-nombre'),
            inP = document.getElementById('modal-rec-porciones');
      if(editRecId!==null){
        const orig = recetas.find(r=>r.id===editRecId);
        inN.value = orig.nombre;
        inP.value = orig.porciones;
      }
      document.getElementById('modal-cancel').onclick = closeModal;
      document.getElementById('modal-confirm').onclick = ()=>{
        const nombre = inN.value.trim(), porciones = parseInt(inP.value,10);
        if(!nombre) return showMessage('La receta necesita nombre.');
        if(isNaN(porciones)||porciones<1) return showMessage('Porciones debe ser ‚â• 1.');
        receta.nombre = nombre; receta.porciones = porciones;
        receta.id = editRecId || Date.now();
        recetas = load('recetas');
        if(editRecId===null){
          recetas.push(receta);
          showMessage('Receta guardada.', false);
        } else {
          const idx = findIndexById(recetas, editRecId);
          recetas[idx] = receta;
          showMessage('Receta actualizada.', false);
        }
        save('recetas', recetas);
        // Reset
        receta = { id:null, nombre:'', porciones:1, items:[] };
        editRecId = null; editRecItemIdx = null;
        btnAddRecIt.textContent = 'Agregar ingrediente';
        recIngSel.innerHTML = buildRecOptions();
        renderReceta();
        closeModal();
      };
      openModal();
    }
    btnSaveRec.onclick = showSaveRecipeModal;

// Ver recetas guardadas
btnViewRecs.onclick = () => {
  const todas = load('recetas');
  const recs = todas.map((r, i) => {
    const costoTotal   = r.items.reduce((s, it) => s + getItemCost(it, [r.id]), 0);
    const costoPorcion = costoTotal / r.porciones;
    return {
      index: i,
      label: `${r.nombre}-Rin:${r.porciones}por`,  // nombre y rinde juntos
      costoTotal,
      costoPorcion
    };
  });
  showSelectModal(recs, null, true);
};


    // Export / Import ingredientes
    btnExportIng.onclick = ()=>{
      try{
        const json = JSON.stringify(load('ingredientes'),null,2);
        navigator.clipboard.writeText(json).then(
          ()=>showMessage('Ingredientes copiados al portapapeles.', false),
          ()=>showMessage('No se pudo copiar al portapapeles.')
        );
      } catch {
        showMessage('Error al generar JSON.');
      }
    };
    btnImportIng.onclick = ()=>{
      modalTitle.textContent='Importar Ingredientes';
      modalBody.innerHTML = `<p>Pega aqu√≠ el JSON exportado:</p><textarea id="import-json"></textarea>`;
      modalFooter.innerHTML = `
        <button id="import-cancel" class="btn-secondary">Cancelar</button>
        <button id="import-confirm" class="btn-primary">Pegar</button>`;
      document.getElementById('import-cancel').onclick = closeModal;
      document.getElementById('import-confirm').onclick = ()=>{
        const text = document.getElementById('import-json').value.trim();
        try{
          const arr = JSON.parse(text);
          if(!Array.isArray(arr)) throw '';
          for(const ing of arr){
            if(typeof ing.id!=='number' || typeof ing.nombre!=='string' ||
               typeof ing.cantidad!=='number' || typeof ing.unidad!=='string' ||
               typeof ing.precio!=='number') throw '';
          }
          save('ingredientes',arr);
          ingredientes = arr;
          renderIngredientes();
          renderReceta();
          showMessage('Ingredientes importados correctamente.', false);
          closeModal();
        } catch {
          showMessage('JSON inv√°lido o formato incorrecto.');
        }
      };
      openModal();
    };
    // 1. Selecciona el bot√≥n
const btnClearAll = document.getElementById('btn-clear-all');

// 2. Funci√≥n que muestra el modal de confirmaci√≥n
function showClearAllModal() {
  modalTitle.textContent = 'Confirmar borrado total';
  modalBody.innerHTML = `
    <p>¬øEst√°s seguro de que deseas eliminar <strong>todos</strong> los ingredientes y recetas?</p>
  `;
  modalFooter.innerHTML = `
    <button id="clearall-cancel" class="btn-secondary">Cancelar</button>
    <button id="clearall-confirm" class="btn-danger">Eliminar todo</button>
  `;
  // Cancelar
  document.getElementById('clearall-cancel').onclick = closeModal;
  // Confirmar
  document.getElementById('clearall-confirm').onclick = () => {
    ingredientes = [];
    recetas = [];
    save('ingredientes', ingredientes);
    save('recetas', recetas);
    renderIngredientes();
    renderReceta();
    showMessage('Se han eliminado todas las recetas e ingredientes.', false);
    closeModal();
  };
  openModal();
}

// 3. Enlaza el bot√≥n al modal de confirmaci√≥n
btnClearAll.onclick = showClearAllModal;

    // --- Copiar lista de ingredientes formateada ---
    const btnCopyIngList = document.getElementById('btn-copy-ingredientes-list');
    btnCopyIngList.onclick = () => {
      const ings = load('ingredientes');
      if (!ings.length) {
        return showMessage('No hay ingredientes para copiar.');
      }
      const lines = ings.map(ing =>
        `- ${ing.nombre}: ${ing.cantidad} ${ing.unidad} ‚Äî $${ing.precio.toFixed(2)}`
      );
      const text = 'Lista de Ingredientes:\n' + lines.join('\n');
      navigator.clipboard.writeText(text)
        .then(() => showMessage('Lista de ingredientes copiada.', false))
        .catch(() => showMessage('Error al copiar la lista.'));
    };

    // --- Copiar recetas con desglose de costos ---
    const btnCopyRecInfo = document.getElementById('btn-copy-recetas-info');
    btnCopyRecInfo.onclick = async () => {
  const recs = load('recetas');
  if (!recs.length) {
    return showMessage('No hay recetas para copiar.');
  }

  // Construimos HTML y Markdown
  const htmlRecetas = recs.map(r => {
    // C√°lculo de costos
    const costosItems = r.items.map(it => {
      const costoIt = getItemCost(it);
      const label = it.tipo === 'I'
        ? ingredientes.find(x => x.id === it.id).nombre
        : recetas.find(x => x.id === it.id).nombre + ' (subreceta)';
      return `<li>${label}: ${it.cantidad} ${it.unidad} ‚Äî $${costoIt.toFixed(2)}</li>`;
    }).join('\n');

    const costoTotal = r.items.reduce((sum, it) => sum + getItemCost(it), 0);
    const costoPorcion = costoTotal / r.porciones;

    return `
<h3>${r.nombre}</h3>
<p>Rinde: ${r.porciones} porciones</p>
<ul>
${costosItems}
</ul>
<p><strong>Costo total:</strong> $${costoTotal.toFixed(2)}</p>
<p><strong>Costo por porci√≥n:</strong> $${costoPorcion.toFixed(2)}</p>
`;
  }).join('\n');

  const mdRecetas = recs.map(r => {
    const lineItems = r.items.map(it => {
      const costoIt = getItemCost(it);
      const label = it.tipo === 'I'
        ? ingredientes.find(x => x.id === it.id).nombre
        : recetas.find(x => x.id === it.id).nombre + ' (subreceta)';
      return `- ${label}: ${it.cantidad} ${it.unidad} ‚Äî $${costoIt.toFixed(2)}`;
    }).join('\n');

    const costoTotal = r.items.reduce((sum, it) => sum + getItemCost(it), 0);
    const costoPorcion = costoTotal / r.porciones;

    return `
${r.nombre}
Rinde: ${r.porciones} porciones

${lineItems}

*Costo total:* $${costoTotal.toFixed(2)}  
*Costo por porci√≥n:* $${costoPorcion.toFixed(2)}
`;
  }).join('\n');

  try {
    await navigator.clipboard.write([
      new ClipboardItem({
        'text/html': new Blob([htmlRecetas], { type: 'text/html' }),
        'text/plain': new Blob([mdRecetas],  { type: 'text/plain' })
      })
    ]);
    showMessage('Recetas detalladas copiadas con costo por porci√≥n.', false);
  } catch (err) {
    // Fallback a plain text
    await navigator.clipboard.writeText(mdRecetas);
    showMessage('No se pudo copiar en HTML; se copi√≥ en texto plano con costo por porci√≥n.', false);
  }
};

    // Actualizar unidad al cambiar selecci√≥n
    function updateRecUnidad(){
      const sel = recIngSel.value;
      if(!sel){ recUniSel.innerHTML = buildOptions(); return; }
      const tipo = sel[0], id = +sel.slice(1);
      if(tipo==='I'){
        const base = ingredientes.find(x=>x.id===id).unidad;
        let opts, label;
        if(unidades.masa.includes(base)){ opts=unidades.masa; label='Masa'; }
        else if(unidades.volumen.includes(base)){ opts=unidades.volumen; label='Volumen'; }
        else if(unidades.medida.includes(base)){ opts=unidades.medida; label='Medidas'; }
        else { opts=unidades.unidad; label='Unidad'; }
        recUniSel.innerHTML = `<optgroup label="${label}">${optionsFrom(opts)}</optgroup>`;
      } else {
        recUniSel.innerHTML = '<option value="porci√≥n">porci√≥n</option>';
      }
    }
    recIngSel.addEventListener('change', updateRecUnidad);

    // Inicial
    renderIngredientes();
    renderReceta();
  </script>
</body>
</html>
